I"ìh<h1 id="purpose">Purpose</h1>
<p>The purpose of the 555 timer-based LED matrix animations project (referred to in
this report as the ‚ÄúTBMA project‚Äù) was to demonstrate how a 555 timer could
still be used in the context of microcontrollers, as well as improve programming
skills and understanding of the 595 shift register.</p>

<p>3 key engineering skills were improved upon in the TBMA project:</p>

<p>Programming skills were improved as a result of having to program a smaller
microcontroller with less SRAM and program space to work with, as well as having
to program two daisy chained shift registers to display the desired images on
the LED matrix. Soldering skills were highly improved upon during this project
due to the fact that all of the columns on the half + size breadboard PCB were
utilized in the circuit, thereby requiring an extensive amount of soldering and
leaving little room for error in the soldering process. Circuit skills were also
refined during this project as the project required extensive wiring and
troubleshooting of the circuit and less attention to the code.</p>

<h1 id="reference">Reference</h1>

<p>http://lucidtronix.com/tutorials/40
http://www.protostack.com/blog/2010/05/introduction-to-74hc595-shift-register-controlling-16-leds/</p>

<h1 id="procedure">Procedure</h1>
<p>The TBMA project circuit was made up of 2 595 shift registers, an ATtiny85
microcontroller, a 555 timer and a 8x8 LED matrix. The 555 timer establishes an
astable square wave pulse that is adjustable by a 10k potentiometer. The output
pin of the 555 timer, which emits the pulse, is hooked up to the external
interrupt pin of the ATtiny85. Each time the output pin of the 555 goes high, an
interrupt is triggered that communicates to the ATtiny85 to show the next frame
of the animation. This effectively allows the 555 timer and the user-adjustable
potentiometer to control the framerate of the animations shown on the LED
matrix. An additional three digital I/O pins of the ATtiny85 are hooked to the
data, latch and clock pins of the shift register handling the columns of the LED
matrix. The shift register controlling the rows is daisy- chained to the shift
register controlling the columns of the LED matrix. The daisy-chaining of the
two shift registers gives the ATtiny85 access to 16 new output pins, which
control the 64 total LEDs on the LED matrix through a process in the code called
scanning. The scanning takes place within a function in the code called
<code class="language-plaintext highlighter-rouge">displayBitMap()</code>. A bitmap consists of an array that holds 8 bytes. The
<code class="language-plaintext highlighter-rouge">displayBitMap()</code> function shifts the binary values from the first byte of the
array into the column shift register and as it is the first byte of the array,
it is shown on the first row of the LED Matrix. The function then turns off the
first row and shifts out the byte to the column shift register to be shown on
the second row. This process continues until each row has been shown once.
Despite one row being enabled at a time, the scanning process takes place so
rapidly that it appears as though all of the individual illuminated rows on the
LED matrix are illuminated simultaneously. This is due to an optical illusion
called persistence of vision. Persistence of vision is an optical illusion
whereby multiple discrete images blend into one. In this case, the individual
illuminated rows on the LED matrix are perceived as one image.</p>

<table>
  <thead>
    <tr>
      <th style="text-align: center">Parts List</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center">2 595 Shift Registers</td>
    </tr>
    <tr>
      <td style="text-align: center">ATtiny85 Microcontroller</td>
    </tr>
    <tr>
      <td style="text-align: center">555 Timer IC</td>
    </tr>
    <tr>
      <td style="text-align: center">8x8 LED Matrix</td>
    </tr>
    <tr>
      <td style="text-align: center">8 x 330Œ© Resistors</td>
    </tr>
    <tr>
      <td style="text-align: center">1k Œ© Resistor</td>
    </tr>
    <tr>
      <td style="text-align: center">Adafruit Half Breadboard PCB</td>
    </tr>
    <tr>
      <td style="text-align: center">Blue Acrylic Chassis</td>
    </tr>
    <tr>
      <td style="text-align: center">9V Power Supply</td>
    </tr>
  </tbody>
</table>

<p>The first step in the construction of the TBMA project was the creation of the
circuit. The circuit was initiated by establishing an astable pulse from a 555
timer. The 555 timer was then hooked to a potentiometer so the speed of the
pulse could be adjusted. Additionally, an ATtiny85 was added to the circuit
along with two 595 shift registers. The ATtiny85 was hooked up to the output pin
of the 555 timer, along with the first of two 595 shift registers. The second
shift register was daisy-chained to the first, allowing the ATtiny85 to control
16 new pins with only 3 of its own. Following the wiring of the integrated
circuits (ICs), the next step was to set up the LED matrix. Setting up the LED
matrix was an arduous process of testing each pin on the matrix to determine
what column or row it represented. The purpose of each pin on the matrix was
noted on a diagram that was used for reference when wiring the matrix through
different iterations of the circuit. The final step in the construction of the
circuit was the connection of the LED matrix to the shift registers and the
mapping diagram was used for reference during this step.</p>

<p>The second step in the construction of the TBMA project was creating the code to
drive it. The code needed to facilitate communication between the ATtiny85 and
the shift registers, as well as read the pulse from the 555 timer. The approach
to communication with the shift registers was to use a custom function called
<code class="language-plaintext highlighter-rouge">writeRegs()</code>. The <code class="language-plaintext highlighter-rouge">writeRegs()</code> function took the data to shift out from an
array of Booleans that contained the requested state of all the shift register
pins available. In other words, the state of a pin on the shift register can be
changed in the Boolean array and the change can be written later by calling
<code class="language-plaintext highlighter-rouge">writeRegs()</code>. This arrangement allowed a large amount of flexibility that was
initially thought to be impossible with the use of daisy-chained shift
registers.</p>

<p>The final and most difficult step of constructing the TBMA project was
soldering. Since the circuit contained 4 ICs and an LED Matrix, a substantial
amount of wiring had to fit onto a half+ size Adafruit breadboard PCB.
Specifically, upon completion of the soldering process for the circuit, all of
the available columns on the board had been completely utilized. The limited
space made for a challenging soldering process where any errors would require
restarting the entire process. However, it should be noted that the breadboard
prototype was available for reference when soldering, which helped with the
process immensely.</p>

<h1 id="media">Media</h1>

<p><a href="https://drive.google.com/file/d/1GH6Gq93gX_H4JwH92iHk1siyGRIAMYL1/view?usp=sharing">Demo Video</a></p>

<p><img src="../assets/img/555-Animations/soldered-top1.jpg" alt="Soldered Prototype" /></p>
<center><b>Soldered Prototype</b></center>

<h1 id="code">Code</h1>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="cm">/*
Author: Ethan Peterson
Date: November 26, 2016
TEI3M
*/</span>
<span class="c1">// Define Shift Register Pins:</span>
<span class="cp">#define clk 3
#define latch 4
#define data 0
#define shiftRegNum 2
#define shiftRegPinNum shiftRegNum * 8
</span>
<span class="c1">// create a boolean array to store the state of every</span>
<span class="c1">// 595 pin available</span>
<span class="n">bool</span> <span class="n">registers</span><span class="p">[</span><span class="n">shiftRegPinNum</span><span class="p">];</span>
<span class="c1">// frame variable that is incremented every time the output pin of the 555 goes</span>
<span class="c1">// high</span>
<span class="kt">uint8_t</span> <span class="n">frame</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="kt">uint8_t</span> <span class="n">animations</span><span class="p">[][</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="c1">// 2d array storing bitmaps for every individual</span>
                            <span class="c1">// frame of the animations</span>
    <span class="p">{</span>                       <span class="c1">// happy - sad animation</span>
     <span class="n">B00111100</span><span class="p">,</span> <span class="n">B01000010</span><span class="p">,</span> <span class="n">B10100101</span><span class="p">,</span> <span class="n">B10000001</span><span class="p">,</span> <span class="n">B10100101</span><span class="p">,</span> <span class="n">B10011001</span><span class="p">,</span>
     <span class="n">B01000010</span><span class="p">,</span> <span class="n">B00111100</span><span class="p">},</span>
    <span class="p">{</span><span class="n">B00111100</span><span class="p">,</span> <span class="n">B01000010</span><span class="p">,</span> <span class="n">B10100101</span><span class="p">,</span> <span class="n">B10000001</span><span class="p">,</span> <span class="n">B10111101</span><span class="p">,</span> <span class="n">B10000001</span><span class="p">,</span>
     <span class="n">B01000010</span><span class="p">,</span> <span class="n">B00111100</span><span class="p">},</span>
    <span class="p">{</span><span class="n">B00111100</span><span class="p">,</span> <span class="n">B01000010</span><span class="p">,</span> <span class="n">B10100101</span><span class="p">,</span> <span class="n">B10000001</span><span class="p">,</span> <span class="n">B10011001</span><span class="p">,</span> <span class="n">B10100101</span><span class="p">,</span>
     <span class="n">B01000010</span><span class="p">,</span> <span class="n">B00111100</span><span class="p">},</span>
    <span class="p">{</span><span class="n">B00111100</span><span class="p">,</span> <span class="n">B01000010</span><span class="p">,</span> <span class="n">B10100101</span><span class="p">,</span> <span class="n">B10000001</span><span class="p">,</span> <span class="n">B10100101</span><span class="p">,</span> <span class="n">B10011001</span><span class="p">,</span>
     <span class="n">B01000010</span><span class="p">,</span> <span class="n">B00111100</span><span class="p">},</span>
    <span class="p">{</span><span class="n">B00111100</span><span class="p">,</span> <span class="n">B01000010</span><span class="p">,</span> <span class="n">B10100101</span><span class="p">,</span> <span class="n">B10000001</span><span class="p">,</span> <span class="n">B10111101</span><span class="p">,</span> <span class="n">B10000001</span><span class="p">,</span>
     <span class="n">B01000010</span><span class="p">,</span> <span class="n">B00111100</span><span class="p">},</span>
    <span class="p">{</span><span class="n">B00111100</span><span class="p">,</span> <span class="n">B01000010</span><span class="p">,</span> <span class="n">B10100101</span><span class="p">,</span> <span class="n">B10000001</span><span class="p">,</span> <span class="n">B10011001</span><span class="p">,</span> <span class="n">B10100101</span><span class="p">,</span>
     <span class="n">B01000010</span><span class="p">,</span> <span class="n">B00111100</span><span class="p">},</span>
    <span class="p">{</span><span class="n">B00111100</span><span class="p">,</span> <span class="n">B01000010</span><span class="p">,</span> <span class="n">B10100101</span><span class="p">,</span> <span class="n">B10000001</span><span class="p">,</span> <span class="n">B10111101</span><span class="p">,</span> <span class="n">B10000001</span><span class="p">,</span>
     <span class="n">B01000010</span><span class="p">,</span> <span class="n">B00111100</span><span class="p">},</span>
    <span class="p">{</span><span class="c1">// space invader animation</span>
     <span class="n">B00011000</span><span class="p">,</span> <span class="n">B00111100</span><span class="p">,</span> <span class="n">B01111110</span><span class="p">,</span> <span class="n">B11011011</span><span class="p">,</span> <span class="n">B11111111</span><span class="p">,</span> <span class="n">B00100100</span><span class="p">,</span>
     <span class="n">B00011000</span><span class="p">,</span> <span class="n">B00000000</span><span class="p">},</span>
    <span class="p">{</span><span class="n">B00011000</span><span class="p">,</span> <span class="n">B00111100</span><span class="p">,</span> <span class="n">B01111110</span><span class="p">,</span> <span class="n">B11011011</span><span class="p">,</span> <span class="n">B11111111</span><span class="p">,</span> <span class="n">B00100100</span><span class="p">,</span>
     <span class="n">B01011010</span><span class="p">,</span> <span class="n">B10100101</span><span class="p">},</span>
    <span class="p">{</span><span class="n">B00011000</span><span class="p">,</span> <span class="n">B00111100</span><span class="p">,</span> <span class="n">B01111110</span><span class="p">,</span> <span class="n">B11011011</span><span class="p">,</span> <span class="n">B11111111</span><span class="p">,</span> <span class="n">B00100100</span><span class="p">,</span>
     <span class="n">B00011000</span><span class="p">,</span> <span class="n">B00000000</span><span class="p">},</span>
    <span class="p">{</span><span class="n">B00011000</span><span class="p">,</span> <span class="n">B00111100</span><span class="p">,</span> <span class="n">B01111110</span><span class="p">,</span> <span class="n">B11011011</span><span class="p">,</span> <span class="n">B11111111</span><span class="p">,</span> <span class="n">B00100100</span><span class="p">,</span>
     <span class="n">B01011010</span><span class="p">,</span> <span class="n">B10100101</span><span class="p">},</span>
    <span class="p">{</span><span class="n">B00011000</span><span class="p">,</span> <span class="n">B00111100</span><span class="p">,</span> <span class="n">B01111110</span><span class="p">,</span> <span class="n">B11011011</span><span class="p">,</span> <span class="n">B11111111</span><span class="p">,</span> <span class="n">B00100100</span><span class="p">,</span>
     <span class="n">B00011000</span><span class="p">,</span> <span class="n">B00000000</span><span class="p">},</span>
    <span class="p">{</span><span class="c1">// pac man animation</span>
     <span class="n">B00111100</span><span class="p">,</span> <span class="n">B01111110</span><span class="p">,</span> <span class="n">B11011111</span><span class="p">,</span> <span class="n">B11111111</span><span class="p">,</span> <span class="n">B11110000</span><span class="p">,</span> <span class="n">B11111111</span><span class="p">,</span>
     <span class="n">B01111110</span><span class="p">,</span> <span class="n">B00111100</span><span class="p">},</span>
    <span class="p">{</span><span class="n">B00111100</span><span class="p">,</span> <span class="n">B01010110</span><span class="p">,</span> <span class="n">B10010011</span><span class="p">,</span> <span class="n">B11011011</span><span class="p">,</span> <span class="n">B11111111</span><span class="p">,</span> <span class="n">B11111111</span><span class="p">,</span>
     <span class="n">B11011101</span><span class="p">,</span> <span class="n">B10001001</span><span class="p">},</span>
    <span class="p">{</span><span class="n">B00111100</span><span class="p">,</span> <span class="n">B01111110</span><span class="p">,</span> <span class="n">B11011111</span><span class="p">,</span> <span class="n">B11111111</span><span class="p">,</span> <span class="n">B11110000</span><span class="p">,</span> <span class="n">B11111111</span><span class="p">,</span>
     <span class="n">B01111110</span><span class="p">,</span> <span class="n">B00111100</span><span class="p">},</span>
    <span class="p">{</span><span class="n">B00111100</span><span class="p">,</span> <span class="n">B01010110</span><span class="p">,</span> <span class="n">B10010011</span><span class="p">,</span> <span class="n">B11011011</span><span class="p">,</span> <span class="n">B11111111</span><span class="p">,</span> <span class="n">B11111111</span><span class="p">,</span>
     <span class="n">B11011101</span><span class="p">,</span> <span class="n">B10001001</span><span class="p">}</span>

<span class="p">};</span>

<span class="kt">void</span> <span class="nf">setup</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">pinMode</span><span class="p">(</span><span class="n">latch</span><span class="p">,</span> <span class="n">OUTPUT</span><span class="p">);</span> <span class="c1">// data</span>
  <span class="n">pinMode</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">OUTPUT</span><span class="p">);</span>  <span class="c1">// latch</span>
  <span class="n">pinMode</span><span class="p">(</span><span class="n">clk</span><span class="p">,</span> <span class="n">OUTPUT</span><span class="p">);</span>   <span class="c1">// clock</span>
  <span class="c1">// reset all register pins</span>
  <span class="n">clearRegs</span><span class="p">();</span>
  <span class="n">writeRegs</span><span class="p">();</span>
  <span class="c1">// creates an inturrupt where everytime the</span>
  <span class="c1">// output pin of the 555 goes high call the nextFrame() function</span>
  <span class="n">attachInterrupt</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">nextFrame</span><span class="p">,</span> <span class="n">RISING</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">clearRegs</span><span class="p">()</span> <span class="p">{</span> <span class="c1">// clears the registers array but does not write the changes</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">shiftRegPinNum</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">registers</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">LOW</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
<span class="kt">void</span> <span class="nf">writeRegs</span><span class="p">()</span> <span class="p">{</span>
  <span class="c1">// writes data in the registers array to the output pins of</span>
  <span class="c1">// the shift registers</span>
  <span class="n">digitalWrite</span><span class="p">(</span><span class="n">latch</span><span class="p">,</span> <span class="n">LOW</span><span class="p">);</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">shiftRegPinNum</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">digitalWrite</span><span class="p">(</span><span class="n">clk</span><span class="p">,</span> <span class="n">LOW</span><span class="p">);</span>
    <span class="kt">uint8_t</span> <span class="n">val</span> <span class="o">=</span> <span class="n">registers</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
    <span class="n">digitalWrite</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
    <span class="n">digitalWrite</span><span class="p">(</span><span class="n">clk</span><span class="p">,</span> <span class="n">HIGH</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="n">digitalWrite</span><span class="p">(</span><span class="n">latch</span><span class="p">,</span> <span class="n">HIGH</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">setRegPin</span><span class="p">(</span><span class="kt">uint8_t</span> <span class="n">i</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="n">val</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// function changes the value of an individual pin on the 595 by changing the</span>
  <span class="c1">// value in the registers array where the change can be displayed later</span>
  <span class="n">registers</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
<span class="p">}</span>
<span class="kt">void</span> <span class="nf">displayBitMap</span><span class="p">(</span><span class="kt">uint8_t</span> <span class="n">charMap</span><span class="p">[</span><span class="mi">8</span><span class="p">])</span> <span class="p">{</span>
  <span class="c1">// displays a full bit map on the 8x8 matrix</span>
  <span class="c1">// by shifting the right byte onto the correct row with one row lit up at a</span>
  <span class="c1">// time this is taking place so fast that it looks as though all rows are</span>
  <span class="c1">// being illuminated at the same time</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">uint8_t</span> <span class="n">row</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">row</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">row</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// ensure column data is shown on the correct row by illuminating the</span>
    <span class="c1">// current one and making the previous one low</span>
    <span class="n">setRegPin</span><span class="p">(</span><span class="mi">8</span> <span class="o">+</span> <span class="p">(</span><span class="n">row</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
    <span class="n">setRegPin</span><span class="p">(</span><span class="mi">8</span> <span class="o">+</span> <span class="n">row</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">uint8_t</span> <span class="n">col</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">col</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">col</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">charMap</span><span class="p">[</span><span class="n">row</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">col</span><span class="p">))</span> <span class="p">{</span>
        <span class="c1">// invert the bit because col pins must be low to be shown</span>
        <span class="c1">// due to the way the matrix is configured</span>
        <span class="n">setRegPin</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">setRegPin</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">row</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">setRegPin</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span> <span class="c1">// prevent same byte from being shown on two columns</span>
    <span class="p">}</span>
    <span class="n">writeRegs</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">loop</span><span class="p">()</span> <span class="p">{</span>
  <span class="c1">// display animations at the corresponding frame</span>
  <span class="n">displayBitMap</span><span class="p">(</span><span class="n">animations</span><span class="p">[</span><span class="n">frame</span><span class="p">]);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">nextFrame</span><span class="p">()</span> <span class="p">{</span> <span class="c1">// runs every time the output pin of the 555 timer goes high</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">frame</span> <span class="o">==</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">animations</span><span class="p">)</span> <span class="o">/</span> <span class="mi">8</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">frame</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="n">frame</span><span class="o">++</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<h1 id="conclusion">Conclusion</h1>

<p>Overall, the TBMA project was an ambitious undertaking in the areas of circuit
building, programming and soldering. The project was arduous but highly
rewarding upon its completion. The TBMA project allowed the development of
essential skills relating to the wiring and programming of shift registers to
control LED matrices, making the project a great introduction to potentially
more complex projects involving LED matrices.</p>
:ET
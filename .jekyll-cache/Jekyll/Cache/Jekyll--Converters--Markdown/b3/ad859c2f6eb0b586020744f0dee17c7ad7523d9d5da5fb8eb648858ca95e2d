I"j¥<h1 id="purpose">Purpose</h1>
<p>The purpose of the Fingerprint Enabled Door Lock (referred to in this report as
the FEDL) was to create a useful and fun device while bolstering knowledge of
the I2C bus from the last challenge, improving programming ability and most
importantly, using EAGLE to design custom PCBs.</p>

<p>The first skill that was improved in this project was the use of the I2C bus.
Knowledge in this case was improved following an in-class unit on the interface
and Challenge 3.</p>

<p>The second skill improved throughout the duration of the FEDL project was
programming. The Arduino sketch for this project was the largest written to date
due to the various components that were used.</p>

<p>The third and most important skill obtained during the FEDL project was a
working knowledge of the Cadsoft EAGLE software, which is used for the purpose
of designing custom circuit schematics and boards. These designs can
subsequently be submitted to a PCB fabricator for production and shipment of
custom PCBs. The skill of PCB design is essential for larger circuits and
projects where a standard proto-board cannot be used.</p>

<table>
  <thead>
    <tr>
      <th style="text-align: center">Parts List</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center">Custom PCB</td>
    </tr>
    <tr>
      <td style="text-align: center">Adafruit Optical Fingerprint Reader</td>
    </tr>
    <tr>
      <td style="text-align: center">LED Bar Graph</td>
    </tr>
    <tr>
      <td style="text-align: center">11 x 220Î© Resistors</td>
    </tr>
    <tr>
      <td style="text-align: center">2 x 10k Î© Resistor</td>
    </tr>
    <tr>
      <td style="text-align: center">Adafruit Chronodot Real Time Clock Module (RTC)</td>
    </tr>
    <tr>
      <td style="text-align: center">Adafruit I2C 7-Segment Backpack</td>
    </tr>
    <tr>
      <td style="text-align: center">Servo Motor</td>
    </tr>
    <tr>
      <td style="text-align: center">Acrylic Chassis &amp; Lock</td>
    </tr>
    <tr>
      <td style="text-align: center">Push Button</td>
    </tr>
    <tr>
      <td style="text-align: center">Arduino Uno</td>
    </tr>
    <tr>
      <td style="text-align: center">MCP23017 I/O Expander</td>
    </tr>
    <tr>
      <td style="text-align: center">RGB LED (Common Cathode)</td>
    </tr>
  </tbody>
</table>

<h1 id="reference">Reference</h1>

<p><a href="http://datasheets.maximintegrated.com/en/ds/DS3231.pdf">MCP23017 Datasheet</a></p>

<p>PCB Manufacturer Used: Advanced Circuits</p>

<p><a href="http://docs.macetech.com/doku.php/chronodot">Chronodot</a></p>

<p><a href="http://tronixstuff.com/2011/08/26/tutorial-maximising-your-arduinos-io-ports/">I/O Expansion Tutorial</a></p>

<h1 id="procedure">Procedure</h1>

<p>The FEDL project consists mainly of a MCP23017 I2C I/O expander, an LED bar
graph, a Chronodot, an I2C 7-Segment Backpack, a servo motor and an Adafruit
Fingerprint Sensor. The Circuit is housed on a custom PCB, connecting the I/O
expander to the Arduino along with the Chronodot and 7-Segment Display via I2C.
The custom board connects the I/O expander to the LED bar graph and button. The
custom PCB also has input pins from the Arduino to communicate with the
fingerprint sensor and servo outside of the I2C bus. With the custom board tying
all of the components together, Arduino code can be used to create an effective
door lock system.</p>

<p>The construction of the FEDL is broken down into 3 steps: Prototype circuit,
board design and fabrication and the code.</p>

<p>Prototyping the circuit is the first and easiest step in the making of the FEDL.
Since the circuit contains many I2C components, the wiring for most of the
circuit involves connecting the SDA and SCL pins to the various components. The
connection of the fingerprint scanner and servo motor requires only 3 pins each,
making the wiring of the FEDL circuit extremely straightforward.</p>

<p><img src="../assets/img/FEDL/breadboard-proto.jpg" alt="Breadboard Prototype" /></p>
<center><b>Breadboard Prototype</b></center>

<p>The second and most difficult step of building the FEDL was the board design and
fabrication. The process of designing a custom PCB involved learning how to use
the Cadsoft EAGLE software. EAGLE is the most common software used for board
design. The first step was to create a working schematic within EAGLE. This
required finding all of the parts needed for the circuit within the EAGLE part
picker. Once the schematic was completed and checked as thoroughly as possible
for errors, the EAGLE software was switched to board view. The board view
function was used to place the parts on the board in the desired fashion. Once
the PCB was laid out properly, the next step was to run the autorouter. The
autorouter automatically connects the components as specified in the schematic
by placing physical traces that will be printed on the board when it is ordered.
Following the completion of the routing, the board was ordered from a PCB
fabrication company called Advanced Circuits. The first iteration of the FEDL
PCB was delivered a few days later. An issue was encountered with the first PCB
in that the pads where the RGB LED would be soldered were connected and would
therefore cause a short circuit. The DRC (Design Rule Check) function within
EAGLE warned of this, however, it was initially thought that the issue could be
simply fixed by cutting the traces on the board manually. Despite the RGB LED
issue, the rest of the board had to be tested. The first custom PCB was soldered
excluding the RGB LED and it functioned properly. Once it was determined that
the first design functioned properly, EAGLE was used to change the design of the
board to fix the error with the RGB LED by using a simple pin header component
instead of a component specifically designed for a RGB LED. Additionally, a pin
header was added to the board for the Arduino software serial pins required to
operate the fingerprint sensor, which was omitted from the previous design as it
was thought that the fingerprint scanner could be directly connected to the
Arduino. The second iteration of the board was ordered and delivered
approximately one week prior to the ISP presentation date allowing ample time
for soldering and testing. Once the board was soldered and tested, it was
mounted along with the Arduino on a slab of acrylic, which acted as a chassis
for the components.</p>

<p><img src="../assets/img/FEDL/pcb.jpg" alt="Soldered PCB Prototype" /></p>
<center><b>Soldered PCB Prototype</b></center>

<p><img src="../assets/img/FEDL/schematic.png" alt="PCB Schematic" /></p>
<center><b>EAGLE Schematic</b></center>

<p>The third and final step of building the FEDL project was the programming. With
the custom PCB already soldered and tested, a functioning circuit had been
produced and the programming process could commence. The first step of the
programming process was using the Wire library to read time data from the
Chronodot RTC. Developing this functionality required the use of the Chronodotâ€™s
datasheet, which indicated which addresses within the chipâ€™s memory had the
required information (such as hour and minute). Once data was successfully
retrieved from the Chronodot, two new functions called <code class="highlighter-rouge">hour()</code> and <code class="highlighter-rouge">minute()</code> were
created that returned the current hour and minute as an integer. The time
obtained from these functions was displayed on the 7-Segment display using
Adafruitâ€™s library. The second step of the programming process was to operate
the I/O pins on the MCP23017 in the same manner as on the Arduino. Three
functions were developed for this purpose: <code class="highlighter-rouge">mcWrite()</code>, <code class="highlighter-rouge">mcRead()</code> and <code class="highlighter-rouge">mcPinMode()</code>,
which recreated the <code class="highlighter-rouge">digitalWrite()</code>, <code class="highlighter-rouge">digitalRead()</code> and <code class="highlighter-rouge">pinMode()</code>
functions on the Arduino. Completing these new functions required the Wire
library and extensive use of bitwise operators as the functions had to have the
ability to change bits in the MCP23017â€™s registers. The third step of the
programming process was to read data from the fingerprint scanner and check if
the correct finger is placed on the sensor. Adafruitâ€™s fingerprint scanner
library was used to achieve this.</p>

<h1 id="demo">Demo</h1>

<p><a href="https://drive.google.com/file/d/19g8dXAoRY6Fjd4KnBrcxNGFMfQXK6uGg/view?usp=sharing">Video</a></p>

<h1 id="code">Code</h1>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="cp">#include "Arduino.h"
#include &lt;Servo.h&gt; // For easy control of a servo for locking and unlocking the door
#include &lt;SoftwareSerial.h&gt; // For Serial communication with the fingerprint sensor
#include &lt;Wire.h&gt;           // For I2C communication between various components
</span>
<span class="c1">// 7 Segment Backpack libraries:</span>
<span class="cp">#include "Adafruit_LEDBackpack.h"
#include &lt;Adafruit_GFX.h&gt;
</span><span class="c1">// Fingerprint Scanner Library:</span>
<span class="cp">#include &lt;Adafruit_Fingerprint.h&gt;
</span>
<span class="cp">#ifndef SYMBOL
#define expanderAddress 0x20 // i2c address of MCP23017
#define portADir 0x00 // Direction Register address for PORT A (pins 0-7 will be PORTA)
#define portBDir 0x01 // Direction Register address for PORT B (pins 8 - 15 will be PORT B)
</span>
<span class="c1">// GPIO PORT A and B addressing</span>
<span class="cp">#define portA 0x12
#define portB 0x13
</span><span class="c1">// 7-Segment Backpack Address:</span>
<span class="cp">#define displayAddress 0x70
</span>
<span class="c1">// RTC address</span>
<span class="cp">#define timeAddress                                                            \
  0x68 // I2C address to access time registers on the Chronodot
</span>
<span class="c1">// BCD to decimal converter for values read from the RTC</span>
<span class="c1">// preprocessor definition of a function</span>
<span class="cp">#define bcdToDec(bcdVal)                                                       \
  (((bcdVal &amp; 0b11110000) &gt;&gt; 4) * 10 + (bcdVal &amp; 0b00001111))
</span>
<span class="c1">// define button pin</span>
<span class="cp">#define button 13
</span>
<span class="c1">// define function to check if nth bit is set or cleared in byte</span>
<span class="cp">#define bitCheck(inputVar, position) ((inputVar) &amp; (1 &lt;&lt; position))
#define fingerId 0   // id # of my fingerprint stored in the senor
#define servoPin 9   // PWM pin on arduino used to control the Servo Motor
#define lockedPos 85 // servo position for locked door
#define openPos 180  // servo positon for unlocked door
#endif
</span>
          <span class="n">Adafruit_7segment</span> <span class="n">clockDisplay</span> <span class="o">=</span> <span class="n">Adafruit_7segment</span><span class="p">();</span>

<span class="n">SoftwareSerial</span> <span class="nf">mySerial</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
<span class="n">Adafruit_Fingerprint</span> <span class="n">finger</span> <span class="o">=</span> <span class="n">Adafruit_Fingerprint</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mySerial</span><span class="p">);</span>

<span class="n">Servo</span> <span class="n">servo</span><span class="p">;</span>

<span class="c1">// make variables to hold the values in each of the MCP23017's registers</span>
<span class="c1">// pin direction registers</span>
<span class="kt">uint8_t</span> <span class="n">portADirValue</span> <span class="o">=</span> <span class="mi">255</span><span class="p">;</span>
<span class="kt">uint8_t</span> <span class="n">portBDirValue</span> <span class="o">=</span> <span class="mi">255</span><span class="p">;</span>

<span class="c1">// pin value registers</span>
<span class="kt">uint8_t</span> <span class="n">portAValue</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="kt">uint8_t</span> <span class="n">portBValue</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="n">bool</span> <span class="n">buttonState</span><span class="p">;</span>
<span class="n">bool</span> <span class="n">locked</span><span class="p">;</span>

<span class="c1">// MCP23017 functions</span>
<span class="kt">void</span> <span class="nf">mcPinMode</span><span class="p">(</span><span class="kt">uint8_t</span> <span class="n">pin</span><span class="p">,</span> <span class="n">bool</span> <span class="n">state</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">Wire</span><span class="p">.</span><span class="n">beginTransmission</span><span class="p">(</span><span class="n">expanderAddress</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">pin</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">Wire</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">portADir</span><span class="p">);</span> <span class="c1">// map pins 0-7 to register A</span>
    <span class="n">portADirValue</span> <span class="o">^=</span> <span class="p">(</span><span class="o">~</span><span class="p">(</span><span class="o">-</span><span class="n">state</span><span class="p">)</span> <span class="o">^</span> <span class="n">portADirValue</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">pin</span><span class="p">);</span> <span class="c1">// change bit at pin location to whatever the state boolean is</span>
        <span class="c1">// state boolean is inverted because OUTPUT and INPUT values are</span>
        <span class="c1">// inverted on MCP23017 (OUTPUT = 0, INPUT = 1)</span>
        <span class="n">Wire</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">portADirValue</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="c1">// if is greater or equal to 8</span>
    <span class="n">Wire</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">portBDir</span><span class="p">);</span>
    <span class="n">portBDirValue</span> <span class="o">^=</span> <span class="p">(</span><span class="o">~</span><span class="p">(</span><span class="o">-</span><span class="n">state</span><span class="p">)</span> <span class="o">^</span> <span class="n">portBDirValue</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">pin</span> <span class="o">-</span> <span class="mi">8</span><span class="p">));</span>
    <span class="n">Wire</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">portBDirValue</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="n">Wire</span><span class="p">.</span><span class="n">endTransmission</span><span class="p">();</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">mcWrite</span><span class="p">(</span><span class="kt">uint8_t</span> <span class="n">pin</span><span class="p">,</span> <span class="n">bool</span> <span class="n">state</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">Wire</span><span class="p">.</span><span class="n">beginTransmission</span><span class="p">(</span><span class="n">expanderAddress</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">pin</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">Wire</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">portA</span><span class="p">);</span>
    <span class="n">portAValue</span> <span class="o">^=</span> <span class="p">(</span><span class="o">-</span><span class="n">state</span> <span class="o">^</span> <span class="n">portAValue</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">pin</span><span class="p">);</span>
    <span class="n">Wire</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">portAValue</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="n">Wire</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">portB</span><span class="p">);</span>
    <span class="n">portBValue</span> <span class="o">^=</span> <span class="p">(</span><span class="o">-</span><span class="n">state</span> <span class="o">^</span> <span class="n">portBValue</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">pin</span> <span class="o">-</span> <span class="mi">8</span><span class="p">));</span>
    <span class="n">Wire</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">portBValue</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="n">Wire</span><span class="p">.</span><span class="n">endTransmission</span><span class="p">();</span>
<span class="p">}</span>

<span class="n">bool</span> <span class="nf">mcRead</span><span class="p">(</span><span class="kt">uint8_t</span> <span class="n">pin</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// function serving the same purpose as digitalRead()</span>
  <span class="c1">// that works for the MCP23017</span>
  <span class="n">Wire</span><span class="p">.</span><span class="n">beginTransmission</span><span class="p">(</span><span class="n">expanderAddress</span><span class="p">);</span>
  <span class="kt">uint8_t</span> <span class="n">bitToAccess</span> <span class="o">=</span> <span class="n">pin</span><span class="p">;</span>
  <span class="kt">uint8_t</span> <span class="n">dataRead</span><span class="p">;</span> <span class="c1">// stores input byte obtained from MCP23017</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">pin</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">Wire</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">portA</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="n">Wire</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">portB</span><span class="p">);</span>
    <span class="n">bitToAccess</span> <span class="o">=</span> <span class="n">pin</span> <span class="o">-</span> <span class="mi">8</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">Wire</span><span class="p">.</span><span class="n">endTransmission</span><span class="p">();</span>
  <span class="c1">// request the data</span>
  <span class="n">Wire</span><span class="p">.</span><span class="n">requestFrom</span><span class="p">(</span><span class="n">expanderAddress</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
  <span class="n">dataRead</span> <span class="o">=</span> <span class="n">Wire</span><span class="p">.</span><span class="n">read</span><span class="p">();</span>
  <span class="k">return</span> <span class="n">bitCheck</span><span class="p">(</span><span class="n">dataRead</span><span class="p">,</span>
                  <span class="n">bitToAccess</span><span class="p">);</span> <span class="c1">// returns true if the bit is set and</span>
  <span class="c1">// false if not</span>
<span class="p">}</span>
<span class="c1">// RTC time collection functions</span>
<span class="kt">uint8_t</span> <span class="nf">hour</span><span class="p">()</span> <span class="p">{</span> <span class="c1">// returns hour (0 - 24)</span>
  <span class="n">Wire</span><span class="p">.</span><span class="n">beginTransmission</span><span class="p">(</span><span class="n">timeAddress</span><span class="p">);</span>
  <span class="n">Wire</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="mh">0x02</span><span class="p">);</span> <span class="c1">// start reading data from hours register on the Chronodot</span>
  <span class="n">Wire</span><span class="p">.</span><span class="n">endTransmission</span><span class="p">();</span>
  <span class="c1">// request one byte from the RTC since we start</span>
  <span class="c1">// reading data from the hours register we will get hours</span>
  <span class="n">Wire</span><span class="p">.</span><span class="n">requestFrom</span><span class="p">(</span><span class="n">timeAddress</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
  <span class="kt">uint8_t</span> <span class="n">hours</span> <span class="o">=</span>
      <span class="n">Wire</span><span class="p">.</span><span class="n">read</span><span class="p">();</span> <span class="c1">// mask required due to control bits on hour register &amp;0x3f</span>
  <span class="c1">// different BCD to Decimal conversion requied</span>
  <span class="c1">// due to control bits on hour register</span>
  <span class="n">hours</span> <span class="o">=</span> <span class="p">(((</span><span class="n">hours</span> <span class="o">&amp;</span> <span class="mi">0</span><span class="n">b00100000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">*</span> <span class="mi">20</span> <span class="o">+</span> <span class="p">((</span><span class="n">hours</span> <span class="o">&amp;</span> <span class="mi">0</span><span class="n">b00010000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">*</span> <span class="mi">10</span> <span class="o">+</span>
           <span class="p">(</span><span class="n">hours</span> <span class="o">&amp;</span> <span class="mi">0</span><span class="n">b00001111</span><span class="p">));</span>
  <span class="k">return</span> <span class="n">hours</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">uint8_t</span> <span class="nf">minute</span><span class="p">()</span> <span class="p">{</span> <span class="c1">// returns minute (0 - 59)</span>
  <span class="n">Wire</span><span class="p">.</span><span class="n">beginTransmission</span><span class="p">(</span><span class="n">timeAddress</span><span class="p">);</span>
  <span class="n">Wire</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="mh">0x01</span><span class="p">);</span> <span class="c1">// start at minutes register on Chronodot</span>
  <span class="n">Wire</span><span class="p">.</span><span class="n">endTransmission</span><span class="p">();</span>
  <span class="c1">// request minute data</span>
  <span class="n">Wire</span><span class="p">.</span><span class="n">requestFrom</span><span class="p">(</span><span class="n">timeAddress</span><span class="p">,</span>
                   <span class="mi">1</span><span class="p">);</span> <span class="c1">// request one byte which is the minute value</span>
  <span class="kt">uint8_t</span> <span class="n">minutes</span> <span class="o">=</span> <span class="n">Wire</span><span class="p">.</span><span class="n">read</span><span class="p">();</span>
  <span class="c1">// no mask required on minute register simply convert to decimal</span>
  <span class="k">return</span> <span class="n">bcdToDec</span><span class="p">(</span><span class="n">minutes</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// 7-Segment display functions (and other code to do with visual output)</span>
<span class="kt">void</span> <span class="nf">showTime</span><span class="p">()</span> <span class="p">{</span>
  <span class="c1">// setup variable to print to 7-Segment displays</span>
  <span class="kt">uint8_t</span> <span class="n">h</span> <span class="o">=</span> <span class="n">hour</span><span class="p">();</span>
  <span class="kt">uint8_t</span> <span class="n">m</span> <span class="o">=</span> <span class="n">minute</span><span class="p">();</span>
  <span class="kt">int</span> <span class="n">theTime</span> <span class="o">=</span> <span class="n">h</span> <span class="o">*</span> <span class="mi">100</span> <span class="o">+</span> <span class="n">m</span><span class="p">;</span>
  <span class="c1">// do 24 to 12 hour time conversion</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">h</span> <span class="o">&gt;</span> <span class="mi">12</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">theTime</span> <span class="o">-=</span> <span class="mi">1200</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">h</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// handle midnight where h = 0</span>
    <span class="n">theTime</span> <span class="o">+=</span> <span class="mi">1200</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">clockDisplay</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">theTime</span><span class="p">);</span>

  <span class="c1">// show colon on the display between hour and min</span>
  <span class="n">clockDisplay</span><span class="p">.</span><span class="n">drawColon</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
  <span class="n">clockDisplay</span><span class="p">.</span><span class="n">writeDisplay</span><span class="p">();</span> <span class="c1">// show changes on the display</span>
<span class="p">}</span>

<span class="c1">// shows progress of door being unlocked on bargraph</span>
<span class="kt">void</span> <span class="nf">showBars</span><span class="p">(</span><span class="kt">uint8_t</span> <span class="n">barNum</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// clear Bargraph first</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">9</span><span class="p">;</span> <span class="n">j</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">j</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">mcWrite</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">LOW</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="c1">// display specified # of bars on led bargraph</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">barNum</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">mcWrite</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">HIGH</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
  <span class="kt">uint8_t</span> <span class="n">red</span><span class="p">;</span>
  <span class="kt">uint8_t</span> <span class="n">green</span><span class="p">;</span>
  <span class="kt">uint8_t</span> <span class="n">blue</span><span class="p">;</span>
<span class="p">}</span> <span class="n">RGBLed</span><span class="p">;</span>
<span class="n">RGBLed</span> <span class="n">rgb</span> <span class="o">=</span> <span class="p">{</span><span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">12</span><span class="p">};</span>

<span class="c1">// Fingerprint sensor code</span>
<span class="kt">uint8_t</span> <span class="nf">getID</span><span class="p">()</span> <span class="p">{</span>
  <span class="kt">uint8_t</span> <span class="n">f</span> <span class="o">=</span> <span class="n">finger</span><span class="p">.</span><span class="n">getImage</span><span class="p">();</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">f</span> <span class="o">!=</span> <span class="n">FINGERPRINT_OK</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">f</span> <span class="o">=</span> <span class="n">finger</span><span class="p">.</span><span class="n">image2Tz</span><span class="p">();</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">f</span> <span class="o">!=</span> <span class="n">FINGERPRINT_OK</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">f</span> <span class="o">=</span> <span class="n">finger</span><span class="p">.</span><span class="n">fingerFastSearch</span><span class="p">();</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">f</span> <span class="o">!=</span> <span class="n">FINGERPRINT_OK</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">finger</span><span class="p">.</span><span class="n">fingerID</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// changes door from locked to unlocked depending on bool passed to the</span>
<span class="c1">// function</span>
<span class="kt">void</span> <span class="nf">lockState</span><span class="p">(</span><span class="n">bool</span> <span class="n">state</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">servo</span><span class="p">.</span><span class="n">attach</span><span class="p">(</span><span class="mi">9</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">openPos</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="n">lockedPos</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">servo</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
      <span class="kt">uint8_t</span> <span class="n">bars</span> <span class="o">=</span> <span class="n">map</span><span class="p">(</span><span class="n">servo</span><span class="p">.</span><span class="n">read</span><span class="p">(),</span> <span class="n">lockedPos</span><span class="p">,</span> <span class="n">openPos</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">11</span><span class="p">);</span>
      <span class="n">showBars</span><span class="p">(</span><span class="n">bars</span><span class="p">);</span>
      <span class="n">delay</span><span class="p">(</span><span class="mi">25</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="n">lockedPos</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">openPos</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">servo</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">j</span><span class="p">);</span>
      <span class="kt">uint8_t</span> <span class="n">bars</span> <span class="o">=</span> <span class="n">map</span><span class="p">(</span><span class="n">servo</span><span class="p">.</span><span class="n">read</span><span class="p">(),</span> <span class="n">lockedPos</span><span class="p">,</span> <span class="n">openPos</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">11</span><span class="p">);</span>
      <span class="n">showBars</span><span class="p">(</span><span class="n">bars</span><span class="p">);</span>
      <span class="n">delay</span><span class="p">(</span><span class="mi">25</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="n">servo</span><span class="p">.</span><span class="n">detach</span><span class="p">();</span> <span class="c1">// prevent noise</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">scan</span><span class="p">()</span> <span class="p">{</span> <span class="c1">// runs in a loop scanning for a correct fingerprint on the sensor</span>
  <span class="n">bool</span> <span class="n">fingerAvailable</span> <span class="o">=</span> <span class="n">finger</span><span class="p">.</span><span class="n">verifyPassword</span><span class="p">();</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">getID</span><span class="p">()</span> <span class="o">==</span> <span class="n">fingerId</span> <span class="o">&amp;&amp;</span> <span class="n">fingerAvailable</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">mcWrite</span><span class="p">(</span><span class="n">rgb</span><span class="p">.</span><span class="n">green</span><span class="p">,</span> <span class="n">HIGH</span><span class="p">);</span>
    <span class="n">mcWrite</span><span class="p">(</span><span class="n">rgb</span><span class="p">.</span><span class="n">red</span><span class="p">,</span> <span class="n">LOW</span><span class="p">);</span>
    <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">"FOUND ID: "</span><span class="p">);</span>
    <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">fingerId</span><span class="p">);</span>
    <span class="n">locked</span> <span class="o">=</span> <span class="o">!</span><span class="n">locked</span><span class="p">;</span>
    <span class="n">lockState</span><span class="p">(</span><span class="n">locked</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="n">mcWrite</span><span class="p">(</span><span class="n">rgb</span><span class="p">.</span><span class="n">green</span><span class="p">,</span> <span class="n">LOW</span><span class="p">);</span>
    <span class="n">mcWrite</span><span class="p">(</span><span class="n">rgb</span><span class="p">.</span><span class="n">red</span><span class="p">,</span> <span class="n">HIGH</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">buttonScan</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">buttonState</span> <span class="o">=</span> <span class="n">mcRead</span><span class="p">(</span><span class="n">button</span><span class="p">);</span>
  <span class="n">delay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">buttonState</span> <span class="o">!=</span> <span class="n">mcRead</span><span class="p">(</span><span class="n">button</span><span class="p">))</span> <span class="p">{</span>
    <span class="n">locked</span> <span class="o">=</span> <span class="o">!</span><span class="n">locked</span><span class="p">;</span>
    <span class="n">lockState</span><span class="p">(</span><span class="n">locked</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">initIO</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">Wire</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span>
  <span class="n">pinMode</span><span class="p">(</span><span class="n">A4</span><span class="p">,</span> <span class="n">OUTPUT</span><span class="p">);</span>
  <span class="n">pinMode</span><span class="p">(</span><span class="n">A5</span><span class="p">,</span> <span class="n">OUTPUT</span><span class="p">);</span>
  <span class="n">Serial</span><span class="p">.</span><span class="n">begin</span><span class="p">(</span><span class="mi">9600</span><span class="p">);</span>
  <span class="c1">// Set all pins on MCP23017 to input by default</span>
  <span class="n">Wire</span><span class="p">.</span><span class="n">beginTransmission</span><span class="p">(</span><span class="n">expanderAddress</span><span class="p">);</span>
  <span class="n">Wire</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">portADir</span><span class="p">);</span>
  <span class="n">Wire</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="mi">255</span><span class="p">);</span>
  <span class="n">Wire</span><span class="p">.</span><span class="n">endTransmission</span><span class="p">();</span>
  <span class="c1">// PORT B</span>
  <span class="n">Wire</span><span class="p">.</span><span class="n">beginTransmission</span><span class="p">(</span><span class="n">expanderAddress</span><span class="p">);</span>
  <span class="n">Wire</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">portBDir</span><span class="p">);</span>
  <span class="n">Wire</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="mi">255</span><span class="p">);</span>
  <span class="n">Wire</span><span class="p">.</span><span class="n">endTransmission</span><span class="p">();</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">uint8_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// Set pins 0-9 to OUTPUT for led bargraph</span>
    <span class="n">mcPinMode</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">OUTPUT</span><span class="p">);</span>
    <span class="n">mcWrite</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">LOW</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="c1">// initialize the 7-Segment Display</span>
  <span class="n">clockDisplay</span><span class="p">.</span><span class="n">begin</span><span class="p">(</span><span class="n">displayAddress</span><span class="p">);</span>
  <span class="n">finger</span><span class="p">.</span><span class="n">begin</span><span class="p">(</span><span class="mi">57600</span><span class="p">);</span>
  <span class="c1">// initialize Servo</span>
  <span class="n">servo</span><span class="p">.</span><span class="n">attach</span><span class="p">(</span><span class="n">servoPin</span><span class="p">);</span>
  <span class="c1">// Set RGB LED pins to OUTPUT</span>
  <span class="n">mcPinMode</span><span class="p">(</span><span class="n">rgb</span><span class="p">.</span><span class="n">red</span><span class="p">,</span> <span class="n">OUTPUT</span><span class="p">);</span>
  <span class="n">mcPinMode</span><span class="p">(</span><span class="n">rgb</span><span class="p">.</span><span class="n">green</span><span class="p">,</span> <span class="n">OUTPUT</span><span class="p">);</span>
  <span class="n">mcPinMode</span><span class="p">(</span><span class="n">rgb</span><span class="p">.</span><span class="n">blue</span><span class="p">,</span> <span class="n">OUTPUT</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">setup</span><span class="p">()</span> <span class="p">{</span> <span class="n">initIO</span><span class="p">();</span> <span class="p">}</span>

<span class="kt">void</span> <span class="nf">loop</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">scan</span><span class="p">();</span>
  <span class="n">showTime</span><span class="p">();</span>
  <span class="n">buttonScan</span><span class="p">();</span>
<span class="p">}</span></code></pre></figure>

<h1 id="conclusion">Conclusion</h1>

<p>Overall, the FEDL was a challenging project that allowed for growth in the areas
of programming and circuit board design. The project culminated in a product
that is useful on an everyday basis.</p>

:ET